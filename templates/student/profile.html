<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Profile</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='students/auth.css') }}">
</head>

<body>
  <div class="loginwrapper">
    <h2>My Profile</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <p class="flash">{{ message }}</p>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="profileForm" method="POST" action="{{ url_for('student.profile_update') }}" enctype="multipart/form-data">

      <!-- CENTERED PROFILE IMAGE -->
      <div class="profile-pic-wrap">
        {% if student['profile_pic'] %}
          <img id="previewImg"
               src="{{ url_for('static', filename='uploads/' ~ student['profile_pic']) }}"
               alt="Profile Picture"
               class="profile-pic">
        {% else %}
          <img id="previewImg"
               src=""
               alt="Preview"
               class="profile-pic"
               style="display:none;">
        {% endif %}
      </div>

      <label><strong>Matric Number (cannot be changed)</strong></label>
      <input type="text" value="{{ student['matric_no'] }}" disabled />

      <label><strong>Department (cannot be changed)</strong></label>
      <input type="text" value="{{ student['department'] or 'Not set' }}" disabled />

      <label for="full_name"><strong>Full Name</strong></label>
      <input type="text" id="full_name" name="full_name" value="{{ student['full_name'] }}" required />

      <label for="email"><strong>Email</strong></label>
      <input type="email" id="email" name="email" value="{{ student['email'] }}" required />

      <label for="profile_pic"><strong>Profile Picture</strong></label>
      <input type="file" id="profile_pic" name="profile_pic" accept=".png,.jpg,.jpeg,.webp" />

      <button class="submit-btn" type="submit" id="saveBtn">Save Changes</button>

      <div class="help-links" style="margin-top:12px;">
        <a href="{{ url_for('student.dashboard') }}">Back to Dashboard</a>
      </div>
    </form>
  </div>

<script>
(function () {
  const fileInput = document.getElementById("profile_pic");
  const preview = document.getElementById("previewImg");
  const form = document.getElementById("profileForm");
  const btn = document.getElementById("saveBtn");

  if (fileInput) {
    fileInput.addEventListener("change", function () {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      const allowed = ["image/png", "image/jpeg", "image/webp"];
      if (!allowed.includes(file.type)) {
        alert("Invalid file type. Please select PNG, JPG, or WEBP.");
        fileInput.value = "";
        return;
      }

      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = "block";
    });
  }

  form.addEventListener("submit", function () {
    btn.disabled = true;
    btn.textContent = "Saving...";
  });
})();
</script>

</body>
</html>
